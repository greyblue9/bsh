
public static Class defineClassNative(String className, byte[] b) { File dir = new File("/data/local/tmp_clazzes"); Class xcls = null;   File file = new File(dir, String.format("%x_classes.dex", System.currentTimeMillis())); FileUtils.writeByteArrayToFile(file, b); try { DexFile df = new DexFile(file); xcls = DexFile.defineClassNative(className, Thread.currentThread().getContextClassLoader(), df.mCookie); } catch (Throwable e) { String[] out = CollectionUtil.selectLines(PosixFileInputStream.pexecSync("logcat", "-d", "*:s", "dalvikvm:E"), "ERROR: bad checksum"); ArrayUtils.reverse(out); cksum = (int)Long.valueOf(out[0].substring(out[0].lastIndexOf('(') + 1, out[0].lastIndexOf('(') + 9).trim(), 16); newckb = Arrays.copyOfRange(ByteUtil.encodeUnsignedValue(cksum, 1), 1, 5); System.arraycopy(newckb, 0, b, 8, 4); FileUtils.writeByteArrayToFile(file, b); DexFile df = new DexFile(file); xcls = DexFile.defineClassNative(className, Thread.currentThread().getContextClassLoader(), df.mCookie); }; return xcls; }

